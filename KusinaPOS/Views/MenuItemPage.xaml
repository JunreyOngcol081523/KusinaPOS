<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sf="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
             xmlns:expander="clr-namespace:Syncfusion.Maui.Expander;assembly=Syncfusion.Maui.Expander"
             xmlns:buttons="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
             xmlns:editors="clr-namespace:Syncfusion.Maui.Inputs;assembly=Syncfusion.Maui.Inputs"
             xmlns:behaviors="clr-namespace:Syncfusion.Maui.Core.Internals;assembly=Syncfusion.Maui.Core"
             x:Class="KusinaPOS.Views.MenuItemPage"
             xmlns:viewmodels="clr-namespace:KusinaPOS.ViewModel"
             xmlns:models="clr-namespace:KusinaPOS.Models"
             xmlns:converters="clr-namespace:KusinaPOS.Converters"
             BackgroundColor="{StaticResource BackgroundDark}">

    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Top Header -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto" Margin="0,0,0,20">
            <ImageButton Grid.Column="0"
                    Margin="0,0,15,0"
                    WidthRequest="30"
                    HeightRequest="30"
                    Command="{Binding GoBackCommand}"
                    Source="arrowback.png"
                    BackgroundColor="Transparent">
            </ImageButton>
            <Label Grid.Column="1" 
                   Text="{Binding StoreName, StringFormat='Manage Menu - {0}'}"
                   FontSize="24" 
                   FontAttributes="Bold"
                   TextColor="{StaticResource TextPrimary}"
                   VerticalOptions="Center" />

            <Label Grid.Column="2" 
                   Text="{Binding CurrentDateTime}" 
                   FontSize="12"
                   TextColor="{StaticResource TextSecondary}"
                   VerticalOptions="Center"
                   Margin="0,0,15,0" />

            <HorizontalStackLayout Grid.Column="3" Spacing="8" VerticalOptions="Center">
                <Label Text="{Binding LoggedInUserName}" 
                       FontSize="12"
                       TextColor="{StaticResource TextSecondary}"
                       VerticalOptions="Center" />
                <Border StrokeShape="RoundRectangle 15"
                        WidthRequest="30"
                        HeightRequest="30"
                        BackgroundColor="{StaticResource Primary}">
                    <Label Text="âš™" 
                           FontSize="16"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           TextColor="White" />
                </Border>
            </HorizontalStackLayout>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*,1.2*" ColumnSpacing="20">

            <!-- Left Side - Menu Categories & Items -->
            <Border Grid.Column="0" 
                    BackgroundColor="{StaticResource SurfaceDark}"
                    StrokeShape="RoundRectangle 15"
                    Padding="20">
                <Grid RowDefinitions="Auto,Auto,*,Auto" RowSpacing="15">

                    <!-- Header -->
                    <Label Grid.Row="0"
                           Text="Menu Categories &amp; Items" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}" />

                    <!-- Search and Add Category -->
                    <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="10">
                        <sf:SfTextInputLayout Grid.Column="0"
                                                       Hint="Category Name"
                                                       HelperText="Add new Category"
                                                       ContainerType="None"
                                                       OutlineCornerRadius="10"
                                                       ContainerBackground="{StaticResource Gray200}">
                            <Entry TextColor="{StaticResource TextPrimary}"
                                   PlaceholderColor="{StaticResource Gray500}"
                                   Text="{Binding NewCategoryName}"/>
                        </sf:SfTextInputLayout>

                        <Button Grid.Column="1"
                                Text="Add Category"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                FontSize="14"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                
                                WidthRequest="130" 
                                Command="{Binding AddCategoryCommand}"/>
                    </Grid>

                    <!-- Menu Items List with Expanders -->
                    <ScrollView Grid.Row="2">
                        <VerticalStackLayout Spacing="10" BindableLayout.ItemsSource="{Binding CategoriesWithMenuItems}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:CategoryViewModel">
                                    <expander:SfExpander IsExpanded="{Binding IsExpanded}">
                                        <expander:SfExpander.Header>
                                            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10" Padding="15,10">
                                                <Label Grid.Column="0"
                                   Text="{Binding Name}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextPrimary}"
                                   VerticalOptions="Center" />

                                                <Border Grid.Column="1"
                                    StrokeShape="RoundRectangle 5"
                                    BackgroundColor="Transparent"
                                    Stroke="{StaticResource Gray400}"
                                    StrokeThickness="1"
                                    WidthRequest="28"
                                    HeightRequest="28"
                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MenuItemViewModel}}, Path=EditCategoryCommand}"
                                                          CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label Text="âœï¸" FontSize="12" HorizontalOptions="Center" VerticalOptions="Center" />
                                                </Border>

                                                <Border Grid.Column="2"
                                    StrokeShape="RoundRectangle 5"
                                    BackgroundColor="Transparent"
                                    Stroke="{StaticResource Gray400}"
                                    StrokeThickness="1"
                                    WidthRequest="28"
                                    HeightRequest="28"
                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MenuItemViewModel}}, Path=DeleteCategoryCommand}"
                                                          CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label Text="ðŸ—‘ï¸" FontSize="12" HorizontalOptions="Center" VerticalOptions="Center" />
                                                </Border>
                                            </Grid>
                                        </expander:SfExpander.Header>

                                        <expander:SfExpander.Content>
                                            <VerticalStackLayout Spacing="5" Padding="10,0">

                                                <!-- Per-Category Search -->
  
                                                    <SearchBar Text="{Binding SearchText, Mode=TwoWay}"
                                                               Placeholder="Search Menu Item"
                                                           TextColor="{StaticResource TextPrimary}"
                                                           PlaceholderColor="{StaticResource Gray500}" />


                                                <!-- Filtered Menu Items List -->
                                                <VerticalStackLayout Spacing="5" BindableLayout.ItemsSource="{Binding FilteredMenuItems}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="models:MenuItem">
                                                            <Border BackgroundColor="{StaticResource Gray200}"
                                                                    StrokeShape="RoundRectangle 8"
                                                                    Padding="15,10">
                                                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="10">
                                                                    <Label Grid.Column="0"
                                                                            Text="{Binding Name}"
                                                                            FontSize="14"
                                                                            TextColor="{StaticResource TextPrimary}"
                                                                            VerticalOptions="Center" />

                                                                    <Label Grid.Column="1"
                                                                           Text="{Binding IsActive, Converter={StaticResource BoolToStatusConverter}}"
                                                                           FontSize="12"
                                                                           TextColor="{StaticResource TextSecondary}"
                                                                           VerticalOptions="Center" />

                                                                    <buttons:SfSwitch Grid.Column="2"
                                                                              IsOn="{Binding IsActive, Mode=TwoWay}"
                                                                              WidthRequest="50"
                                                                              HeightRequest="30"
                                                                              VerticalOptions="Center"
                                                                              StateChanged="SfSwitch_StateChanged" />

                                                                    <Border Grid.Column="3"
                                                                            StrokeShape="RoundRectangle 5"
                                                                            BackgroundColor="Transparent"
                                                                            Stroke="{StaticResource Gray400}"
                                                                            StrokeThickness="1"
                                                                            WidthRequest="30"
                                                                            HeightRequest="30"
                                                                            VerticalOptions="Center">
                                                                        <Border.GestureRecognizers>
                                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MenuItemViewModel}}, Path=EditMenuItemCommand}"
                                                                              CommandParameter="{Binding .}" />
                                                                        </Border.GestureRecognizers>
                                                                        <Image Source="edit.png" HeightRequest="30"/>
                                                                    </Border>
                                                                    <Border Grid.Column="4"
                                                                            StrokeShape="RoundRectangle 5"
                                                                            BackgroundColor="Transparent"
                                                                            Stroke="{StaticResource Gray400}"
                                                                            StrokeThickness="1"
                                                                            WidthRequest="30"
                                                                            HeightRequest="30"
                                                                            VerticalOptions="Center">
                                                                        <Border.GestureRecognizers>
                                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MenuItemViewModel}}, Path=DeleteMenuItemCommand}"
                                                                              CommandParameter="{Binding .}" />
                                                                        </Border.GestureRecognizers>
                                                                        <Image Source="delete.png" HeightRequest="30"/>
                                                                    </Border>
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>

                                                    <BindableLayout.EmptyView>
                                                        <Label Text="No menu items match your search"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray500}"
                                           HorizontalOptions="Center"
                                           Margin="0,10" />
                                                    </BindableLayout.EmptyView>
                                                </VerticalStackLayout>
                                            </VerticalStackLayout>
                                        </expander:SfExpander.Content>
                                    </expander:SfExpander>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>

                            <BindableLayout.EmptyView>
                                <Label Text="No categories yet. Add one to get started!"
                   FontSize="14"
                   TextColor="{StaticResource Gray500}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Margin="0,50" />
                            </BindableLayout.EmptyView>
                        </VerticalStackLayout>
                    </ScrollView>


                    <!-- Add New Item Button -->
                    <Button Grid.Row="3"
                            Text="ADD NEW ITEM"
                            BackgroundColor="Transparent"
                            BorderColor="{StaticResource Primary}"
                            BorderWidth="2"
                            TextColor="{StaticResource Primary}"
                            FontSize="14"
                            FontAttributes="Bold"
                            CornerRadius="10"
                            HeightRequest="50"
                            Command="{Binding AddMenuItemCommand}"/>

                </Grid>
            </Border>

            <!-- Right Side - Edit Menu Item Form (REORGANIZED) -->
            <Border Grid.Column="1" 
                    BackgroundColor="{StaticResource SurfaceDark}"
                    StrokeShape="RoundRectangle 15"
                    Padding="20"
                    IsVisible="{Binding IsBorderVisible}">
                <Grid RowDefinitions="Auto,*,Auto" RowSpacing="20">

                    <!-- Header with Active Toggle -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="{Binding LabelText}" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextPrimary}"
                               VerticalOptions="Center" />

                        <HorizontalStackLayout Grid.Column="1" Spacing="10">
                            <Label Text="{Binding IsActive, Converter={StaticResource BoolToStatusConverter}}"
                                   FontSize="14"
                                   TextColor="{StaticResource TextPrimary}"
                                   VerticalOptions="Center" />
                            <buttons:SfSwitch IsOn="{Binding IsActive, Mode=TwoWay}"
                                              WidthRequest="60"
                                              HeightRequest="32" />
                        </HorizontalStackLayout>
                    </Grid>

                    <!-- Form Fields -->
  
                    <ScrollView Grid.Row="1">
                        <VerticalStackLayout Padding="0">

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,220"
                                  ColumnDefinitions="1.2*,*"
                                  RowSpacing="10"
                                  ColumnSpacing="15">

                                <!-- Row 0: Item Name -->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                                    <Label Text="Item Name"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                    <sf:SfTextInputLayout Hint="Enter item name"
                                                          ContainerType="Outlined"
                                                          OutlineCornerRadius="10"
                                                          ContainerBackground="{StaticResource Gray200}">
                                        <Entry Text="{Binding MenuItemName, Mode=TwoWay}"
                                                TextColor="{StaticResource TextPrimary}" />
                                    </sf:SfTextInputLayout>
                                </VerticalStackLayout>

                                <!-- Row 0: Menu Type -->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8">
                                    <HorizontalStackLayout Spacing="10" Margin="0,0,0,5">
                                        <Label Text="Menu Type"
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextSecondary}" />
                                        <Label Text="What's this?"
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextDecorations="Underline"
                                               TextColor="Blue">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding ShowMenuTypeDialogCommand}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </HorizontalStackLayout>

                                    <editors:SfComboBox HeightRequest="66"
                                                        Placeholder="Select type"
                                                        ItemsSource="{Binding MenuTypes}"
                                                        Text="{Binding SelectedMenuType, Mode=TwoWay}"
                                                        TextColor="{StaticResource TextPrimary}"
                                                        BackgroundColor="{StaticResource Gray100}"
                                                        Stroke="{StaticResource Gray400}"
                                                        IsEditable="true" />
                                </VerticalStackLayout>

                                <!-- Row 1: Category -->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="5">
                                    <Label Text="Category"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                    <editors:SfComboBox HeightRequest="66"
                                                        Placeholder="Select category"
                                                        ItemsSource="{Binding CategoriesWithMenuItems}"
                                                        Text="{Binding SelectedCategory, Mode=TwoWay}"
                                                        DisplayMemberPath="Name"
                                                        TextMemberPath="Name"
                                                        TextColor="{StaticResource TextPrimary}"
                                                        BackgroundColor="{StaticResource Gray100}"
                                                        Stroke="{StaticResource Gray400}"
                                                        IsEditable="true" />
                                </VerticalStackLayout>

                                <!-- Row 1: Price -->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="5">
                                    <Label Text="Sell Price (â‚±)"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                    <sf:SfTextInputLayout 
                                                          ContainerType="Outlined"
                                                          OutlineCornerRadius="10"
                                                          ContainerBackground="{StaticResource Gray200}">
                                        <Entry Keyboard="Numeric"
                                               Text="{Binding MenuItemPrice, Mode=TwoWay}"
                                               TextColor="{StaticResource TextPrimary}" />
                                    </sf:SfTextInputLayout>
                                </VerticalStackLayout>

                                <!-- Row 2: Unit-based forms -->
                                <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,*"
                                      RowDefinitions="*,*"
                                      ColumnSpacing="15"
                                      IsVisible="{Binding SelectedMenuType, Converter={StaticResource UnitToBoolConverter}}"
                                      >
                                    <!-- Row 2: Unit -->
                                    <VerticalStackLayout Grid.Column="0" Grid.Row="0"  Spacing="5"
                                                    >
                                        <Label Text="Unit"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" 
                                           />
                                        <editors:SfComboBox HeightRequest="66"
                                                        Placeholder="Select unit"
                                                        ItemsSource="{Binding UnitMeasurements}"
                                                        Text="{Binding SelectedUnit, Mode=TwoWay}"
                                                        TextColor="{StaticResource TextPrimary}"
                                                        BackgroundColor="{StaticResource Gray100}"/>
                                    </VerticalStackLayout>

                                    <!-- Row 2: Initial Stock -->
                                    <VerticalStackLayout Grid.Column="1" Grid.Row="0"  Spacing="5"
                                                    >
                                        <Label Text="Initial Stocks"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                        <sf:SfTextInputLayout
                                                      ContainerType="Outlined"
                                                      OutlineCornerRadius="10"
                                                      ContainerBackground="{StaticResource Gray200}">
                                            <Entry Keyboard="Numeric"
                                                Text="{Binding InitialStock, Mode=TwoWay}" />
                                        </sf:SfTextInputLayout>
                                    </VerticalStackLayout>

                                    <!-- Row 3: Cost Per Unit -->
                                    <VerticalStackLayout Grid.Column="0" Grid.Row="1" Spacing="5"
                                                        >
                                        <Label Text="Cost per Unit (â‚±)"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                        <sf:SfTextInputLayout
                                                      ContainerType="Outlined"
                                                      OutlineCornerRadius="10"
                                                      ContainerBackground="{StaticResource Gray200}">
                                            <Entry Keyboard="Numeric"
                                                Text="{Binding CostPerUnit, Mode=TwoWay}" />
                                        </sf:SfTextInputLayout>
                                    </VerticalStackLayout>

                                    <!-- Row 3: Reorder Level -->
                                    <VerticalStackLayout Grid.Column="1" Grid.Row="1" Spacing="5"
                                                        >
                                        <Label Text="Re-order Level"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                        <editors:SfNumericEntry HeightRequest="80"
                                                            Minimum="1"
                                                            Maximum="999"
                                                            UpDownPlacementMode="Inline"
                                                            HorizontalOptions="Fill"
                                                            CustomFormat="0"
                                                            VerticalOptions="Center" 
                                                            Value="{Binding ReOrderLevel, Mode=TwoWay}"
                                                            TextColor="{StaticResource TextPrimary}"
                                                                BackgroundColor="{StaticResource Gray100}"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <!-- Row 4: Description -->
                                <VerticalStackLayout Grid.Row="3" Grid.ColumnSpan="2" Spacing="8">
                                    <Label Text="Description"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />
                                    <Border BackgroundColor="{StaticResource Gray200}"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="10"
                                            HeightRequest="80">
                                        <Editor Placeholder="Enter item description..."
                                                Text="{Binding MenuDescription, Mode=TwoWay}"
                                                TextColor="{StaticResource TextPrimary}"
                                                BackgroundColor="Transparent" />
                                    </Border>
                                </VerticalStackLayout>

                                <!-- Row 5: Image Upload  -->
                                <VerticalStackLayout Grid.Row="4"
                                                     Grid.ColumnSpan="2"
                                                     Spacing="8"
                                                     HeightRequest="220">

                                    <Label Text="Item Image"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />

                                    <Grid ColumnDefinitions="120,*"
                                        ColumnSpacing="15">

                                        <Border Style="{StaticResource CardBorder}"
                                                Grid.Column="0"
                                                WidthRequest="120"
                                                HeightRequest="120"
                                                BackgroundColor="Green">
                                            <Image Source="{Binding MenuImageSource}"
                                                   WidthRequest="120"
                                                   HeightRequest="120"
                                                   Aspect="AspectFill" />
                                        </Border>
                                        

                                        <Border Grid.Column="1" 
                                            BackgroundColor="{StaticResource Gray200}"
                                                Style="{StaticResource CardBorder}"
                                                Stroke="{StaticResource Primary}"
                                                StrokeThickness="2"
                                                StrokeDashArray="5,5"
                                                Padding="20">
                                            <VerticalStackLayout HorizontalOptions="Center">
                                                <Label Text="ðŸ“" FontSize="32" />
                                                <Label Text="{Binding ImageLabel}"
                                                        FontAttributes="Bold" />
                                                <Label Text="PNG, JPG (max. 5MB)"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Gray500}" />
                                            </VerticalStackLayout>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                            </Border.GestureRecognizers>
                                        </Border>

                                    </Grid>
                                </VerticalStackLayout>

                            </Grid>

                        </VerticalStackLayout>
                    </ScrollView>



                    <!-- Action Buttons -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="15">
                        <Button Grid.Column="0"
                                Text="CANCEL"
                                BackgroundColor="Transparent"
                                BorderColor="{StaticResource Gray400}"
                                BorderWidth="2"
                                TextColor="{StaticResource TextPrimary}"
                                FontSize="14"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="50"
                                Command="{Binding HideBorderCommand}"/>

                        <Button Grid.Column="1"
                                Text="SAVE CHANGES"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                FontSize="14"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="50"
                                Command="{Binding SaveMenuItemCommand}"/>
                    </Grid>

                </Grid>
            </Border>

        </Grid>

    </Grid>

</ContentPage>