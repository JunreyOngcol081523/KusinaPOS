<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:tabView="clr-namespace:Syncfusion.Maui.TabView;assembly=Syncfusion.Maui.TabView"
    x:Class="KusinaPOS.Views.SettingsPage"
    Title="Settings">

    <Grid Padding="16">

        <tabView:SfTabView x:Name="settingTabView"
                           TabBarPlacement="Bottom"
                           TabBarCornerRadius="24"
                           ContentTransitionDuration ="1000"
                           >

            <tabView:SfTabView.Items>

                <!-- ================= STORE SETTINGS ================= -->
                <tabView:SfTabItem Header="Store Settings"
                                   ImageSource="settings.png"
                                   BackgroundColor="{StaticResource CardBackground}" 
                                    TextColor="{StaticResource TextPrimary}"
                                    FontSize="18"
                                    ImageSize="40"
                                    ImagePosition="Left"
                                   >
                    <ScrollView>
                        <VerticalStackLayout Padding="16" Spacing="12">

                            <Label Text="Store Information"
                           FontSize="18"
                           FontAttributes="Bold" />

                            <Entry Placeholder="Store Name"
                                    Text="{Binding StoreName}" />

                            <Entry Placeholder="Store Address"
                                    Text="{Binding StoreAddress}" />

                            <Label Text="Store Logo"
                                    FontAttributes="Bold" />

                            <VerticalStackLayout
                                                     Spacing="8"
                                                     HeightRequest="220">

                                <Label Text="Item Image"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />

                                <Grid ColumnDefinitions="120,*"
                                        ColumnSpacing="15">

                                    <Border Style="{StaticResource CardBorder}"
                                                Grid.Column="0"
                                                WidthRequest="120"
                                                HeightRequest="120"
                                                BackgroundColor="{StaticResource BackgroundDarker}">
                                        <Image Source="{Binding StoreImageSource}"
                                                   WidthRequest="120"
                                                   HeightRequest="120"
                                                   Aspect="AspectFill" />
                                    </Border>


                                    <Border Grid.Column="1" 
                                            BackgroundColor="{StaticResource Gray200}"
                                                Style="{StaticResource CardBorder}"
                                                Stroke="{StaticResource Primary}"
                                                StrokeThickness="2"
                                                StrokeDashArray="5,5"
                                                Padding="20">
                                        <VerticalStackLayout HorizontalOptions="Center">
                                            <Label Text="ðŸ“" FontSize="32" />
                                            <Label Text="{Binding ImageLabel}"
                                                        FontAttributes="Bold" />
                                            <Label Text="PNG, JPG (max. 5MB)"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Gray500}" />
                                        </VerticalStackLayout>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                        </Border.GestureRecognizers>
                                    </Border>

                                </Grid>
                            </VerticalStackLayout>

                            <Button Text="Save Store Settings"
                                    Command="{Binding SaveStoreSettingsCommand}"
                                    TextColor="White" />

                        </VerticalStackLayout>
                    </ScrollView>
                </tabView:SfTabItem>

                <!-- ================= DATABASE SETTINGS ================= -->
                <tabView:SfTabItem Header="Database Settings"
                                   ImageSource="database.png"
                                   BackgroundColor="{StaticResource CardBackground}" 
                                    TextColor="{StaticResource TextPrimary}"
                                    FontSize="18"
                                    ImageSize="40"
                                    ImagePosition="Left">
                    <Grid RowDefinitions="*">

                        <!-- Loading Overlay -->
                        <ActivityIndicator Grid.Row="0"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="{StaticResource Primary}"
                          HeightRequest="50"
                          WidthRequest="50"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"
                          ZIndex="1" />

                        <ScrollView Grid.Row="0">
                            <VerticalStackLayout Padding="16" Spacing="14">

                                <!-- Backup Section Header -->
                                <Label Text="Database Backup"
                       FontSize="20"
                       FontAttributes="Bold"
                       Margin="0,0,0,10" />

                                <!-- Backup Button -->
                                <Button Text="Create New Backup"
                        Command="{Binding BackupDatabaseCommand}"
                        TextColor="White"
                        HeightRequest="50"
                        CornerRadius="8"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                                <!-- Backup List Header -->
                                <HorizontalStackLayout Spacing="10" Margin="0,20,0,10">
                                    <Label Text="Available Backups"
                           FontSize="18"
                           FontAttributes="Bold"
                           VerticalOptions="Center" />
                                    <Label Text="{Binding Backups.Count, StringFormat='({0})'}"
                           FontSize="16"
                           TextColor="Gray"
                           VerticalOptions="Center" />
                                    <Image Source="refresh.png"
                           HeightRequest="24"
                           WidthRequest="24"
                           HorizontalOptions="End"
                           Opacity="{Binding IsBusy, Converter={StaticResource BoolToOpacityConverter}}">
                                        <Image.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding RefreshBackupsCommand}" />
                                        </Image.GestureRecognizers>
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" 
                                       Binding="{Binding IsBusy}" 
                                       Value="True">
                                                <Setter Property="IsEnabled" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                </HorizontalStackLayout>

                                <!-- Backups List with RefreshView -->
                                <RefreshView IsRefreshing="{Binding IsRefreshing}"
                            Command="{Binding RefreshBackupsCommand}"
                            RefreshColor="{StaticResource Primary}">

                                    <CollectionView ItemsSource="{Binding Backups}"
                                   MinimumHeightRequest="200">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource CardBorder}"
                                       Padding="16"
                                       Margin="0,10,0,0"
                                       BackgroundColor="Transparent">
                                                    <Grid RowDefinitions="Auto,Auto,Auto"
                                          ColumnDefinitions="*,Auto"
                                          RowSpacing="12">

                                                        <!-- Backup Name -->
                                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding FileName}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               LineBreakMode="TailTruncation" />

                                                        <!-- Date & Time -->
                                                        <HorizontalStackLayout Grid.Row="1" Grid.Column="0" 
                                                              Spacing="15">
                                                            <HorizontalStackLayout Spacing="6">
                                                                <Image Source="calendar.png"
                                                       HeightRequest="14"
                                                       WidthRequest="14"
                                                       VerticalOptions="Center" />
                                                                <Label Text="{Binding FormattedDate}"
                                                       FontSize="14"
                                                       VerticalOptions="Center" />
                                                            </HorizontalStackLayout>

                                                            <HorizontalStackLayout Spacing="6">
                                                                <Image Source="clock.png"
                                                       HeightRequest="14"
                                                       WidthRequest="14"
                                                       VerticalOptions="Center" />
                                                                <Label Text="{Binding FormattedTime}"
                                                       FontSize="14"
                                                       VerticalOptions="Center" />
                                                            </HorizontalStackLayout>
                                                        </HorizontalStackLayout>

                                                        <!-- File Size -->
                                                        <HorizontalStackLayout Grid.Row="2" Grid.Column="0"
                                                              Spacing="6">
                                                            <Image Source="file.png"
                                                   HeightRequest="14"
                                                   WidthRequest="14"
                                                   VerticalOptions="Center" />
                                                            <Label Text="{Binding FileSizeFormatted}"
                                                   FontSize="13"
                                                   VerticalOptions="Center" />
                                                        </HorizontalStackLayout>

                                                        <!-- Action Buttons -->
                                                        <HorizontalStackLayout Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                                              Spacing="12"
                                                              VerticalOptions="Center">

                                                            <!-- Share Button -->
                                                            <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#007AFF"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShareBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <Image Source="share.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                            </Border>

                                                            <!-- Restore Button -->
                                                            <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#34C759"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RestoreBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <Image Source="restore.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                            </Border>

                                                            <!-- Delete Button -->
                                                            <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#FF3B30"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <Image Source="delete.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                            </Border>

                                                        </HorizontalStackLayout>

                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>

                                        <!-- Empty View -->
                                        <CollectionView.EmptyView>
                                            <VerticalStackLayout HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                Spacing="12"
                                                Padding="40"
                                                IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}">
                                                <Image Source="folder_empty.png"
                                       HeightRequest="80"
                                       WidthRequest="80"
                                       Opacity="0.5" />
                                                <Label Text="No backups found"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       TextColor="#999999" />
                                                <Label Text="Pull down to refresh or tap 'Create New Backup'"
                                       FontSize="14"
                                       HorizontalOptions="Center"
                                       TextColor="#BBBBBB" />
                                            </VerticalStackLayout>
                                        </CollectionView.EmptyView>

                                    </CollectionView>

                                </RefreshView>

                            </VerticalStackLayout>
                        </ScrollView>

                    </Grid>
                </tabView:SfTabItem>
                <!--================= ABOUT SETTINGS ================= -->
                <tabView:SfTabItem Header="About"
                   ImageSource="info.png"
                   BackgroundColor="{StaticResource CardBackground}" 
                   TextColor="{StaticResource TextPrimary}"
                   FontSize="18"
                   ImageSize="40"
                   ImagePosition="Left">

                    <Grid BackgroundColor="{StaticResource BackgroundDark}">
                        <WebView Source="{Binding HtmlSource}"
                                VerticalOptions="Fill"
                                 HorizontalOptions="Fill" />
                    </Grid>

                </tabView:SfTabItem>
            </tabView:SfTabView.Items>

        </tabView:SfTabView>


    </Grid>
</ContentPage>
