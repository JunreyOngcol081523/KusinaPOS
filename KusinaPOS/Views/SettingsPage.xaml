<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:tabView="clr-namespace:Syncfusion.Maui.TabView;assembly=Syncfusion.Maui.TabView"
    x:Class="KusinaPOS.Views.SettingsPage"
    xmlns:viewmodel="clr-namespace:KusinaPOS.ViewModel"
    xmlns:views="clr-namespace:KusinaPOS.Views"
    xmlns:badgeView="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
    xmlns:syncfusion="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
     xmlns:syncfusionex="clr-namespace:Syncfusion.Maui.Expander;assembly=Syncfusion.Maui.Expander"
    BackgroundColor="{StaticResource CardBackground}" 
    Title="Settings">

    <Grid Padding="16" RowDefinitions="Auto,*">
        <!-- Top Header -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto" Margin="0,0,0,8">
            <ImageButton Grid.Column="0"
                    Margin="0,0,15,0"
                    WidthRequest="10"
                    HeightRequest="10"
                    Command="{Binding GoBackCommand}"
                    Source="arrowback.png"
                    BackgroundColor="Transparent">
            </ImageButton>
            <Label Grid.Column="1" 
                   Text="{Binding StoreName, StringFormat='App Settings - {0}'}"
                   FontSize="15" 
                   FontAttributes="Bold"
                   TextColor="{StaticResource TextPrimary}"
                   VerticalOptions="Center" />

            <Label Grid.Column="2" 
                   Text="{Binding CurrentDateTime}" 
                   FontSize="12"
                   TextColor="{StaticResource TextSecondary}"
                   VerticalOptions="Center"
                   Margin="0,0,15,0" />

            <HorizontalStackLayout Grid.Column="3" Spacing="8" VerticalOptions="Center">
                <Label Text="{Binding LoggedInUserName}" 
                       FontSize="12"
                       TextColor="{StaticResource TextSecondary}"
                       VerticalOptions="Center" />
                <Border StrokeShape="RoundRectangle 15"
                        WidthRequest="30"
                        HeightRequest="30"
                        BackgroundColor="{StaticResource Primary}">
                    <Label Text="âš™" 
                           FontSize="16"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           TextColor="White" />
                </Border>
            </HorizontalStackLayout>
        </Grid>
        <tabView:SfTabView x:Name="settingTabView"
                           TabBarPlacement="Bottom"
                           TabBarCornerRadius="24"
                           ContentTransitionDuration ="500"
                           Grid.Row="1"
                           
                           >

            <tabView:SfTabView.Items>

                <!-- ================= STORE SETTINGS ================= -->
                <tabView:SfTabItem Header="Store Settings"
                                   ImageSource="settings.png"
                                   BackgroundColor="{StaticResource CardBackground}" 
                                    TextColor="{StaticResource TextPrimary}"
                                    FontSize="12"
                                    ImageSize="20"
                                    ImagePosition="Left"
                                   >
                    <ScrollView>
                        <VerticalStackLayout Padding="8" Spacing="5">

                            <Label Text="Store Information"
                                   FontSize="12"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontAttributes="Bold" />

                            <Entry Placeholder="Store Name"
                                   TextColor="{StaticResource TextPrimary}"
                                    Text="{Binding StoreName}" />

                            <Entry Placeholder="Store Address"
                                   TextColor="{StaticResource TextPrimary}"
                                    Text="{Binding StoreAddress}" />

                            <Label Text="Store Logo"
                                   TextColor="{StaticResource TextPrimary}"
                                    FontAttributes="Bold" />

                            <VerticalStackLayout
                                                     Spacing="8"
                                                     HeightRequest="220">

                                <Label Text="Item Image"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource TextSecondary}" />

                                <Grid ColumnDefinitions="120,*"
                                        ColumnSpacing="15">

                                    <Border Style="{StaticResource CardBorder}"
                                                Grid.Column="0"
                                                WidthRequest="120"
                                                HeightRequest="120"
                                                BackgroundColor="{StaticResource BackgroundDarker}">
                                        <Image Source="{Binding StoreImageSource}"
                                                   WidthRequest="120"
                                                   HeightRequest="120"
                                                   Aspect="AspectFill" />
                                    </Border>


                                    <Border Grid.Column="1" 
                                            BackgroundColor="{StaticResource Gray200}"
                                                Style="{StaticResource CardBorder}"
                                                Stroke="{StaticResource Primary}"
                                                StrokeThickness="2"
                                                StrokeDashArray="5,5"
                                                Padding="15">
                                        <VerticalStackLayout HorizontalOptions="Center">
                                            <Label Text="ðŸ“" FontSize="32" />
                                            <Label Text="{Binding ImageLabel}"
                                                   TextColor="{StaticResource TextPrimary}"
                                                        FontAttributes="Bold" />
                                            <Label Text="PNG, JPG (max. 5MB)"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Gray500}" />
                                        </VerticalStackLayout>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                        </Border.GestureRecognizers>
                                    </Border>

                                </Grid>
                            </VerticalStackLayout>

                            <Button Text="Save Store Settings"
                                    Command="{Binding SaveStoreSettingsCommand}"
                                    TextColor="White" />

                        </VerticalStackLayout>
                    </ScrollView>
                </tabView:SfTabItem>

                <!-- ================= DATABASE SETTINGS ================= -->
                <tabView:SfTabItem Header="Database Settings"
                   ImageSource="database.png"
                   BackgroundColor="{StaticResource CardBackground}"
                   TextColor="{StaticResource TextPrimary}"
                                    FontSize="12"
                                    ImageSize="20"
                   ImagePosition="Left">

                    <Grid Padding="8" RowDefinitions="Auto,Auto,Auto,*">

                        <!-- Loading Overlay -->
                        <ActivityIndicator
                            Grid.RowSpan="4"
                            IsRunning="{Binding IsBusy}"
                            IsVisible="{Binding IsBusy}"
                            Color="{StaticResource Primary}"
                            HeightRequest="50"
                            WidthRequest="50"
                            HorizontalOptions="Center"
                            VerticalOptions="Center"
                            ZIndex="1" />

                        <!-- Header -->
                        <Label Grid.Row="0"
                               Text="Database Backup"
                               TextColor="{StaticResource TextPrimary}"
                               FontSize="12"
                               FontAttributes="Bold"
                               Margin="0,0,0,10" />

                        <!-- Backup Button -->
                        <Button Grid.Row="1"
                                Text="Create New Backup"
                                Command="{Binding BackupDatabaseCommand}"
                                TextColor="White"
                                CornerRadius="8"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                        <!-- Backup List Header -->
                        <HorizontalStackLayout Grid.Row="2"
                                               HorizontalOptions="Fill"
                                               Spacing="5"
                                               Margin="0,8,0,5">
                            <badgeView:SfBadgeView BadgeText="{Binding Backups.Count}">
                                <badgeView:SfBadgeView.Content>
                                    <Button Text="Backups" Command="{Binding RefreshBackupsCommand}"/>
                                </badgeView:SfBadgeView.Content>
                            </badgeView:SfBadgeView>

                        </HorizontalStackLayout>

                        <!-- Backups List -->
                        <RefreshView Grid.Row="3"
                                     IsRefreshing="{Binding IsRefreshing}"
                                     Command="{Binding RefreshBackupsCommand}"
                                     RefreshColor="{StaticResource Primary}">

                            <CollectionView ItemsSource="{Binding Backups}"
                                            VerticalOptions="Fill">

                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Style="{StaticResource CardBorder}"
                                                Padding="12"
                                                Margin="0,10,0,0">

                                            <Grid RowDefinitions="Auto,Auto,Auto"
                                                  ColumnDefinitions="*,Auto"
                                                  RowSpacing="12">

                                                <Label Grid.Row="0"
                                                       Text="{Binding FileName}"
                                                       TextColor="{StaticResource TextPrimary}"
                                                       FontAttributes="Bold"
                                                       FontSize="16" />

                                                <HorizontalStackLayout Grid.Row="1" Spacing="15">
                                                    <Label Text="{Binding FormattedDate}" TextColor="{StaticResource TextSecondary}"/>
                                                    <Label Text="{Binding FormattedTime}" TextColor="{StaticResource TextSecondary}"/>
                                                </HorizontalStackLayout>

                                                <Label Grid.Row="2"
                                                       Text="{Binding FileSizeFormatted}"
                                                       FontSize="13"
                                                       TextColor="{StaticResource TextSecondary}"/>
                                                <!-- Action Buttons -->
                                                <HorizontalStackLayout Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                                              Spacing="12"
                                                              VerticalOptions="Center">

                                                    <!-- Share Button -->
                                                    <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#007AFF"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShareBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <Image Source="share.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                    </Border>

                                                    <!-- Restore Button -->
                                                    <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#34C759"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RestoreBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <Image Source="restore.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                    </Border>

                                                    <!-- Delete Button -->
                                                    <Border StrokeShape="RoundRectangle 8"
                                                   Stroke="#FF3B30"
                                                   StrokeThickness="1"
                                                   BackgroundColor="Transparent"
                                                   Padding="12"
                                                   HeightRequest="50"
                                                   WidthRequest="50">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteBackupCommand}"
                                                        CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <Image Source="delete.png"
                                                       HeightRequest="24"
                                                       WidthRequest="24"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center" />
                                                    </Border>

                                                </HorizontalStackLayout>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>

                                <CollectionView.EmptyView>
                                    <VerticalStackLayout Padding="40"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center">
                                        <Label Text="No backups found"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#999999" />
                                    </VerticalStackLayout>
                                </CollectionView.EmptyView>

                            </CollectionView>

                        </RefreshView>

                    </Grid>
                </tabView:SfTabItem>
                <!--===================PRODUCT SETTINGS===============-->
                <tabView:SfTabItem Header="Items and Categories Settings"
                                   ImageSource="inventory.png"
                                   BackgroundColor="{StaticResource CardBackground}"
                                   TextColor="{StaticResource TextPrimary}"
                                    FontSize="12"
                                    ImageSize="20"
                                    ImagePosition="Left">
                    <ScrollView>
                        <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                            <Border Grid.Row="0" Style="{StaticResource CardBorder}">
                                <syncfusionex:SfExpander AnimationDuration="200" IsExpanded="False">
                                    <syncfusionex:SfExpander.Header>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="48"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="35"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <!-- Header Text -->
                                            <Label Text="Category Settings"
                                                   CharacterSpacing="0.25"
                                                   FontSize="14" 
                                                   Grid.Column="1" 
                                                   VerticalOptions="Center"
                                                   TextColor="{StaticResource TextPrimary}"/>
                                        </Grid>
                                    </syncfusionex:SfExpander.Header>

                                    <syncfusionex:SfExpander.Content>
                                        <VerticalStackLayout Padding="18,8,18,18">
                                            <!-- Add New Category Section -->
                                            <Label Text="Add New Category"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   FontSize="12"
                                                   Margin="0,0,0,5"/>

                                            <Entry Placeholder="Enter New Category Name"
                                                   PlaceholderColor="{StaticResource TextSecondary}"
                                                   HorizontalOptions="Fill"
                                                   Text="{Binding NewCategoryName}"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   Margin="0,0,0,10"/>

                                            <Button Text="Save"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    Command="{Binding AddCategoryCommand}"
                                                    Margin="0,0,0,15"/>

                                            <!-- Categories List -->
                                            <syncfusion:SfListView x:Name="listViewcategories" 
                                                               ItemsSource="{Binding Categories}"
                                                               SelectionBackground="Transparent"
                                                               ItemSize="100">
                                                <syncfusion:SfListView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Padding="10">
                                                            <badgeView:SfBadgeView HorizontalOptions="Fill" 
                                                                                   VerticalOptions="Fill"
                                                                                   BadgeText="{Binding NumberOfMenuUnderThisCategory}">
                                                                <badgeView:SfBadgeView.Content>
                                                                    <Border StrokeShape="RoundRectangle 4,4,4,4"
                                                                            Stroke="#CAC4D0"
                                                                            StrokeThickness="1"
                                                                            BackgroundColor="{StaticResource CardBackground}">
                                                                        <Grid Padding="10" 
                                                                              ColumnDefinitions="*,Auto" 
                                                                              RowDefinitions="Auto">
                                                                            <!-- Category Name -->
                                                                            <Label Text="{Binding Name}" 
                                                                                   FontSize="14"
                                                                                   VerticalOptions="Center"
                                                                                   TextColor="{StaticResource TextPrimary}" />
                                                                            <!-- Delete Icon -->
                                                                            <Image Source="delete.png"
                                                                                   HeightRequest="20"
                                                                                   WidthRequest="20"
                                                                                   VerticalOptions="Center"
                                                                                   Margin="5,0"
                                                                                   Grid.Column="1">
                                                                                <Image.GestureRecognizers>
                                                                                    <TapGestureRecognizer 
                                                                                        Command="{Binding Source={x:Reference listViewcategories}, 
                                                                                        Path=BindingContext.DeleteCategoryCommand}" 
                                                                                        CommandParameter="{Binding .}" />
                                                                                </Image.GestureRecognizers>
                                                                            </Image>
                                                                        </Grid>
                                                                    </Border>
                                                                </badgeView:SfBadgeView.Content>
                                                            </badgeView:SfBadgeView>
                                                        </Grid>
                                                    </DataTemplate>
                                                </syncfusion:SfListView.ItemTemplate>
                                                <syncfusion:SfListView.ItemsLayout>
                                                    <syncfusion:GridLayout SpanCount="4" />
                                                </syncfusion:SfListView.ItemsLayout>
                                            </syncfusion:SfListView>
                                        </VerticalStackLayout>
                                    </syncfusionex:SfExpander.Content>
                                </syncfusionex:SfExpander>
                            </Border>
                            <Border Grid.Row="1">

                            </Border>
                            <Border Grid.Row="2">

                            </Border>
                        </Grid>
                    </ScrollView>

                </tabView:SfTabItem>
                <!--================= ABOUT SETTINGS ================= -->
                <tabView:SfTabItem Header="About"
                   ImageSource="info.png"
                   TextColor="{StaticResource TextPrimary}"
                FontSize="12"
                ImageSize="20"
                   ImagePosition="Left">

                    <Grid RowDefinitions="Auto,*">
                        <Image Grid.Row="0"
                               Source="kusinaposlogo.png"
                               HeightRequest="80"
                               HorizontalOptions="Center"/>
                        <WebView x:Name="AboutWebView"
                                VerticalOptions="Fill"
                                 HorizontalOptions="Fill"
                                 Grid.Row="1"/>
                    </Grid>
                    
                </tabView:SfTabItem>

            </tabView:SfTabView.Items>

        </tabView:SfTabView>


    </Grid>
</ContentPage>
